<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å°ç£åœ°åœ–ï½œåŒæ„/ä¸åŒæ„ äº’å‹•çµ±è¨ˆ</title>
  <!-- D3 & TopoJSON CDN -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <style>
    :root {
      --bg: #f2f2f2;
      --panel: #ffffff;
      --accent: #0077c0;
      --agree: #6D7F97;    /* è«è˜­è¿ªè— */
      --disagree: #976666;
      --text: #222222;
      --muted: #666666;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', 'Noto Sans TC', sans-serif;
    }

    .wrap { max-width: 1200px; margin: 24px auto; padding: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 12px; }
    h1 { font-size: 30px; font-weight: 700; margin: 0; letter-spacing: .5px; }

    .card {
      background: var(--panel);
      border: 1px solid #ccc;
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      color: var(--text);
    }

    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 16px;
      text-align: center;
    }

    /* ä¿®æ”¹ï¼šåœ°åœ–å®¹å™¨ä½ˆå±€ - æ”¹å›ç›¸å°å®šä½ */
    .map-container {
      position: relative;
      display: block;
      margin-top: 20px;
      border: none;
    }

    .map-wrapper {
      position: relative;
      max-width: 700px;
      margin: 0 auto;
      border: none;
      outline: none;
    }

    #map { 
      margin-top:-100px;
      width: 100%; 
      height: 1000px; 
      display: block; 
      border: none;
      border-radius: 12px;
      outline: none;
    }

    .region {
      cursor: pointer;
      stroke: #999;
      stroke-width: .6;
      vector-effect: non-scaling-stroke;
      transition: all 0.3s ease;
    }

    .region:hover {
      filter: brightness(1.3);
      stroke-width: 2px;
      stroke: #FFA500;
    }

    .region.selected { stroke-width: 1.5; stroke: var(--accent); }

    .tooltip { position: fixed; pointer-events: none; z-index: 50; transform: translate(12px, 12px); }
    .tooltip .inner {
      background: var(--panel);
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 10px 12px;
      min-width: 220px;
      box-shadow: 0 8px 20px rgba(0,0,0,.15);
      color: var(--text);
    }
    .tooltip h3 { margin: 0 0 8px; font-size: 14px; letter-spacing: .4px; }
    .tooltip .row { display:flex; align-items:center; justify-content:space-between; margin: 4px 0; font-size: 13px; }

    .pill { padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .pill.agree { background: rgba(109,127,151,.15); color: var(--agree); border: 1px solid rgba(109,127,151,.35); }
    .pill.disagree { background: rgba(151,102,102,.12); color: var(--disagree); border: 1px solid rgba(151,102,102,.32); }

    /* ä¿®æ”¹ï¼šPanel æ¨£å¼ - æ”¹å›å³ä¸‹è§’ */
    #panel {
      position: absolute;
      bottom: 20px;
      right: -60px;
      width: 270px;
      background: var(--panel);
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 6px 12px rgba(0,0,0,.15);
      border: 1px solid #ddd;
      max-height: 450px;
      overflow-y: auto;
      font-size: 12px;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆï¼š768px ä»¥ä¸‹æ™‚ panel ç§»åˆ°ä¸‹æ–¹ */
    @media (max-width: 768px) {
      .map-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      #panel {
        margin-top:-300px;
        position: relative;
        bottom: auto;
        right: auto;
        width: auto;
        max-width: 90%;
        max-height: none;
        margin: 20px auto 0;
        padding: 12px;
      }
      
      #map {
        margin-top:-300px;
        height: 1000px;
      }
      
      h1 {
        font-size: 24px;
      }
    }

    /* æ›´å°å±å¹•å„ªåŒ– */
    @media (max-width: 480px) {
      .container {
        padding: 12px;
      }
      
      #panel {
        margin-top:-300px;
        padding: 16px;
        max-width:95%;
      }
      
      #map {
        margin-top:-300px;
        height: 1100px;
      }
    }

    .stat-row { display:flex; justify-content:space-between; align-items: center; margin:8px 0; padding:4px; border-radius:4px; }
    .stat-row.agree { background: rgba(109,127,151,.15); }
    .stat-row.disagree { background: rgba(196,54,86,.08); }
    .stat-label { font-weight:600; font-size:12px; }
    .stat-value { font-size:12px; font-weight:700; }
    .percentage { font-size:10px; color: var(--muted); margin-left:4px; }
    .total-votes { text-align:center; font-size:12px; margin:10px 0; padding:8px; background:#f8f9fa; border-radius:4px; }
    .big-bar { height:12px; background:#eee; border-radius:6px; margin:10px 0; overflow:hidden; position:relative; }
    .big-bar .agree-fill { background: var(--agree); }
    .big-bar .disagree-fill { background: var(--disagree); }
    .region-info { margin-top:16px; padding-top:10px; border-top:1px solid #eee; }
    .region-title { font-size:16px; font-weight:700; margin-bottom:8px; }
  </style>
</head>
<body>
<div class="container">
  <h1>823ã€Œé‡å•Ÿæ ¸ä¸‰ã€å…¬æŠ•é–‹ç¥¨åœ°åœ–</h1>
  <p style="color:#666; font-size:20px;">é»æ“Šç¸£å¸‚é¡¯ç¤ºè³‡æ–™</p> 
  
  <div class="map-container">
    <div class="map-wrapper">
      <svg id="map"></svg>
      <div id="panel">
        <h2 style="font-size: 14px; margin-bottom: 8px;">å…¨å°ç¥¨æ•¸çµ±è¨ˆ</h2>
        <div id="totalStats"></div>
      </div>
    </div>
  </div>
</div>

<script>
const width = 700, height = 600;
const svg = d3.select("#map")
  .attr("width", "100%")
  .attr("height", height)
  .attr("viewBox", `0 0 ${width} ${height}`)
  .attr("preserveAspectRatio", "xMidYMid meet");

const projection = d3.geoMercator()
  .center([121, 24])
  .scale(8000)
  .translate([width / 2, height / 2]);

function getScale() {
  if (window.innerWidth <= 480) return 6000;  // æ‰‹æ©Ÿæ¯”ä¾‹æ”¾å¤§
  if (window.innerWidth <= 768) return 6000;  // å¹³æ¿
  return 7000;                                 // æ¡Œæ©Ÿ
}
  
const path = d3.geoPath().projection(projection);

const voteData = {
   "åŸºéš†å¸‚": { agree: 0, disagree: 0 },
   "å°åŒ—å¸‚": { agree: 930000, disagree: 80000 },
   "æ–°åŒ—å¸‚": { agree: 1450000, disagree: 1000 },
   "æ¡ƒåœ’å¸‚": { agree: 65000, disagree: 600 },
   "æ–°ç«¹å¸‚": { agree: 150000, disagree: 1400 },
   "æ–°ç«¹ç¸£": { agree: 210000, disagree: 1800 },
   "è‹—æ —ç¸£": { agree: 220000, disagree: 2100 },
   "å°ä¸­å¸‚": { agree: 95000, disagree: 9200 },
   "å½°åŒ–ç¸£": { agree: 43000, disagree: 4700 },
   "å—æŠ•ç¸£": { agree: 17000, disagree: 1800 },
   "é›²æ—ç¸£": { agree: 21000, disagree: 2400 },
   "å˜‰ç¾©å¸‚": { agree: 130000, disagree: 1200 },
   "å˜‰ç¾©ç¸£": { agree: 18000, disagree: 2000 },
   "å°å—å¸‚": { agree: 670000, disagree: 7200 },
   "é«˜é›„å¸‚": { agree: 1000, disagree: 1150000 },
   "å±æ±ç¸£": { agree: 330000, disagree: 370000 },
   "å®œè˜­ç¸£": { agree: 20000, disagree: 2100 },
   "èŠ±è“®ç¸£": { agree: 15000, disagree: 160 },
   "å°æ±ç¸£": { agree: 11000, disagree: 120000 },
   "æ¾æ¹–ç¸£": { agree: 38000, disagree: 42000 },
   "é‡‘é–€ç¸£": { agree: 52000, disagree: 48000 },
   "é€£æ±Ÿç¸£": { agree: 8000, disagree: 9000 }
};

const tooltip = d3.select("body").append("div")
  .attr("class", "tooltip")
  .style("opacity", 0);

d3.json("https://raw.githubusercontent.com/g0v/twgeojson/master/json/twCounty2010.geo.json").then(function(taiwan) {
  svg.selectAll("path")
    .data(taiwan.features)
    .enter().append("path")
    .attr("d", path)
    .attr("class", "region")
    .attr("fill", d => {
      let city = d.properties.COUNTYNAME;
      if(city === "æ¡ƒåœ’ç¸£") city = "æ¡ƒåœ’å¸‚";  
      const data = voteData[city];
      if (!data) return "#ccc";
      return data.agree > data.disagree ? "var(--agree)" : "var(--disagree)";
    })
    .on("mouseover", function(event, d) {
      let city = d.properties.COUNTYNAME;
      if(city === "æ¡ƒåœ’ç¸£") city = "æ¡ƒåœ’å¸‚";
      const data = voteData[city];
      if (!data) return;

      const total = data.agree + data.disagree;
      const agreePct = (data.agree / total * 100).toFixed(2);
      const disagreePct = (data.disagree / total * 100).toFixed(2);

      tooltip.transition().style("opacity", 1);
      tooltip.html(`
        <div class="inner">
          <h3>${city}</h3>
          
          <div class="row"><span class="pill agree">åŒæ„</span><span>${data.agree.toLocaleString()} (${agreePct}%)</span></div>
          <div class="bar" style="height:12px; background:rgba(109,127,151,.15); border-radius:6px; overflow:hidden; margin-bottom:6px;">
            <div class="fill" style="width:${agreePct}%; height:100%; background: var(--agree);"></div>
          </div>

          <div class="row"><span class="pill disagree">ä¸åŒæ„</span><span>${data.disagree.toLocaleString()} (${disagreePct}%)</span></div>
          <div class="bar" style="height:12px; background:rgba(196,54,86,.08); border-radius:6px; overflow:hidden;">
            <div class="fill" style="width:${disagreePct}%; height:100%; background: var(--disagree);"></div>
          </div>
        </div>
      `)
      .style("left", (event.pageX + 15) + "px")
      .style("top", (event.pageY - 28) + "px");
    })
    .on("mousemove", function(event) {
  // é€™è£¡å°±æ˜¯è¦æ”¹çš„åœ°æ–¹ ğŸ‘‡
  const tooltipNode = tooltip.node();
  const tooltipWidth = tooltipNode.offsetWidth;
  const tooltipHeight = tooltipNode.offsetHeight;

  let left = event.pageX + 15;
  let top = event.pageY - 28;

  if (left + tooltipWidth > window.innerWidth) {
    left = event.pageX - tooltipWidth - 15;
  }
  if (top + tooltipHeight > window.innerHeight) {
    top = window.innerHeight - tooltipHeight - 10;
  }
  if (top < 0) {
    top = 10;
  }

  tooltip.style("left", left + "px")
         .style("top", top + "px");
})
    .on("mouseout", function() {
      tooltip.transition().style("opacity", 0);
    })
    .on("click", function(event, d) {
      let city = d.properties.COUNTYNAME;
      if(city === "æ¡ƒåœ’ç¸£") city = "æ¡ƒåœ’å¸‚";
      const data = voteData[city];
      const total = data.agree + data.disagree;
      const agreePct = (data.agree / total * 100).toFixed(2);
      const disagreePct = (data.disagree / total * 100).toFixed(2);

      const panel = d3.select("#panel");
      panel.html(`
        <h3>å…¨å°çµ±è¨ˆ</h3>
        <div id="totalStats"></div>
        <div class="region-info">
          <h3>${city}</h3>

          <!-- åŒæ„ç¥¨ -->
          <div class="bar agree" style="height:40px; border-radius:12px; background: rgba(109,127,151,.15); position: relative; margin:8px 0;">
            <div class="fill" style="width:${agreePct}%; height:100%; background: var(--agree); border-radius:12px 0 0 12px;"></div>
            <div style="position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:space-between; align-items:center; padding:0 12px; color: black; font-weight:bold;">
              <span>åŒæ„ç¥¨</span>
              <span>${data.agree.toLocaleString()} (${agreePct}%)</span>
            </div>
          </div>

          <!-- ä¸åŒæ„ç¥¨ -->
          <div class="bar disagree" style="height:40px; border-radius:12px; background: rgba(196,54,86,.08); position: relative; margin:8px 0;">
            <div class="fill" style="width:${disagreePct}%; height:100%; background: var(--disagree); border-radius:12px 0 0 12px;"></div>
            <div style="position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:space-between; align-items:center; padding:0 12px; color: black; font-weight:bold;">
              <span>ä¸åŒæ„ç¥¨</span>
              <span>${data.disagree.toLocaleString()} (${disagreePct}%)</span>
            </div>
          </div>
        </div>

        <!-- ç¸½æŠ•ç¥¨æ•¸ -->
        <div class="total-votes">
          <strong>ç¸½æŠ•ç¥¨æ•¸ï¼š${total.toLocaleString()} 
          (${(total/20002091*100).toFixed(2)}%)
          </strong>
        </div>
      `);

      displayTotalStats();
    });

  // æ ¸ä¸‰å» ä½ç½®
  const npp3 = projection([120.751667, 21.958056]);

  // åŠ  emoji
  svg.append("text")
     .attr("x", npp3[0])
     .attr("y", npp3[1] + 5)
     .attr("text-anchor", "middle")
     .attr("font-size", "30px")
     .text("â˜¢ï¸");
    
  // æ·»åŠ æ–‡å­—æ¨™ç±¤
  svg.append("text")
      .attr("x", npp3[0] - 85)
      .attr("y", npp3[1] + 3)
      .attr("class", "marker-label")
      .style("font-size", "20px")
      .style("font-family", "å¾®è»Ÿæ­£é»‘é«”, sans-serif")
      .style("font-weight", "bold") 
      .style("fill", "#F7931D")
      .text("æ ¸ä¸‰å» ");
});

// ===== å…¨å°çµ±è¨ˆå‡½æ•¸ =====
function calculateTotalStats() {
  let totalAgree = 0;
  let totalDisagree = 0;

  Object.values(voteData).forEach(data => {
    totalAgree += data.agree;
    totalDisagree += data.disagree;
  });

  const total = totalAgree + totalDisagree;
  const agreePct = (totalAgree / total * 100).toFixed(2);
  const disagreePct = (totalDisagree / total * 100).toFixed(2);

  return { totalAgree, totalDisagree, total, agreePct, disagreePct };
}

function displayTotalStats() {
  const stats = calculateTotalStats();
  const totalPopulation = 20002091;
  const threshold = 5000523;

  const votePct = (stats.total / totalPopulation * 100).toFixed(2);
  const agreePctOfTotal = (stats.totalAgree / totalPopulation * 100).toFixed(2);
  const disagreePctOfTotal = (stats.totalDisagree / totalPopulation * 100).toFixed(2);
  const thresholdPct = (threshold / totalPopulation * 100).toFixed(2);

  d3.select("#totalStats").html(`
    <div class="stat-row agree">
      <span class="stat-label">åŒæ„ç¥¨</span>
      <span>
        <span class="stat-value">${stats.totalAgree.toLocaleString()}</span>
        <span class="percentage">(${stats.agreePct}%)</span>
      </span>
    </div>

    <div class="stat-row disagree">
      <span class="stat-label">ä¸åŒæ„ç¥¨</span>
      <span>
        <span class="stat-value">${stats.totalDisagree.toLocaleString()}</span>
        <span class="percentage">(${stats.disagreePct}%)</span>
      </span>
    </div>

    <div style="position: relative; margin:16px 0; padding-top:20px;">
      <div class="big-bar" style="background:#eee; height:40px; border-radius:12px; position:relative;">
        <div style="position:absolute; top:0; left:0; height:100%; width:${votePct}%; background: rgba(0,0,0,0.05); border-radius:12px;"></div>
        <div style="position:absolute; top:0; left:0; height:100%; width:${agreePctOfTotal}%; background: var(--agree); border-radius:12px 0 0 12px;"></div>
        <div style="position:absolute; top:0; left:${agreePctOfTotal}%; height:100%; width:${disagreePctOfTotal}%; background: var(--disagree);"></div>
        <div class="threshold" style="position:absolute; left:${thresholdPct}%; top:0; width:3px; height:100%; background: yellow;"></div>
      </div>

      <div style="position:absolute; left:${thresholdPct}%; top:-5px; transform:translateX(-50%); font-size:12px; font-weight:bold; color:#F7931D; white-space:nowrap; text-align:center;">
        åŒæ„é–€æª»<br>${threshold.toLocaleString()}äºº
      </div>

      <div style="position:absolute; left:100%; top:45%; width:3px; height:55%; background:#F7931D;"></div>

      <div style="position:absolute; left:88%; top:-5px; transform:translateX(-50%); font-size:12px; font-weight:bold; color:#F7931D; white-space:nowrap; text-align:center;">
        ç¸½æŠ•ç¥¨æ¬Šäºº<br>20,002,091äºº
      </div>
    </div>

    <div class="total-votes">
      <strong>ç¸½æŠ•ç¥¨æ•¸ï¼š${stats.total.toLocaleString()} (${votePct}%)</strong>
    </div>
  `);
}

displayTotalStats();
</script>
</body>
</html>
