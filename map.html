<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>台灣地圖｜同意/不同意 互動統計</title>
  <!-- D3 & TopoJSON CDN -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <style>
    :root {
      --bg: #f2f2f2;
      --panel: #ffffff;
      --accent: #0077c0;
      --agree: #6D7F97;    /* 莫蘭迪藍 */
      --disagree: #976666;
      --text: #222222;
      --muted: #666666;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, 'Microsoft JhengHei', '微軟正黑體', 'Noto Sans TC', sans-serif;
    }

    .wrap { max-width: 1200px; margin: 24px auto; padding: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 12px; }
    h1 { font-size: 30px; font-weight: 700; margin: 0; letter-spacing: .5px; }

    .card {
      background: var(--panel);
      border: 1px solid #ccc;
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      color: var(--text);
    }

    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 16px;
      text-align: center;
    }

    /* 修改：地圖容器佈局 - 改回相對定位 */
    .map-container {
      position: relative;
      display: block;
      margin-top: 20px;
      border: none;
    }

    .map-wrapper {
      position: relative;
      max-width: 700px;
      margin: 0 auto;
      border: none;
      outline: none;
    }

    #map { 
      width: 100%; 
      height: 600px; 
      display: block; 
      border: none;
      border-radius: 12px;
      outline: none;
    }

    .region {
      cursor: pointer;
      stroke: #999;
      stroke-width: .6;
      vector-effect: non-scaling-stroke;
      transition: all 0.3s ease;
    }

    .region:hover {
      filter: brightness(1.3);
      stroke-width: 2px;
      stroke: #F7931D;
    }

    .region.selected { stroke-width: 1.5; stroke: var(--accent); }

    .tooltip { position: fixed; pointer-events: none; z-index: 50; }
    .tooltip .inner {
      background: var(--panel);
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 10px 12px;
      min-width: 220px;
      box-shadow: 0 8px 20px rgba(0,0,0,.15);
      color: var(--text);
    }
    .tooltip h3 { margin: 0 0 8px; font-size: 14px; letter-spacing: .4px; }
    .tooltip .row { display:flex; align-items:center; justify-content:space-between; margin: 4px 0; font-size: 13px; }

    .pill { padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .pill.agree { background: rgba(109,127,151,.15); color: var(--agree); border: 1px solid rgba(109,127,151,.35); }
    .pill.disagree { background: rgba(151,102,102,.12); color: var(--disagree); border: 1px solid rgba(151,102,102,.32); }
    .pill.total { background: rgba(219,212,198,0.15); ; color:#8C846C; border: 1px solid rgba(219,212,198,0.90); }
    
    /* 修改：Panel 樣式 - 改回右下角 */
    #panel {
      position: absolute;
      bottom: 20px;
      right: -60px;
      width: 270px;
      background: var(--panel);
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 6px 12px rgba(0,0,0,.15);
      border: 1px solid #ddd;
      
      font-size: 12px;
    }

    /* 圖例樣式 */
.legend {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 20px;
  gap: 30px;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 1px solid rgba(0,0,0,0.1);
}
    
    /* 響應式設計：768px 以下時 panel 移到下方 */
    @media (max-width: 768px) {
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
       
      #panel {
        position: relative;
        bottom: auto;
        right: auto;
        width: 100%;
        max-width: 350px;
        max-height: none;
        margin-top: 20px;
        padding: 12px;
        text-align: center;
        display:block;
        margin: 0 auto; /* 水平置中 + 上間距 */
      }
      
      #map {
        width:90vw;
        max-width: 350px;
        height: 500px;
        margin: 0 auto;
        display:block;
        text-align:center;
        transform: translateX(50px);
      }
      
      h1 {
        font-size: 24px;
        text-align: center;
      }
    }

    /* 更小屏幕優化 */
    @media (max-width: 480px) {
      .container {
        display: flex;
        justify-content: center;
        text-align: center;
        align-items: center;

      }
      
      .tooltip {
      transform: translateY(-60px)  !important;
        width:180px;
        pointer-events: none;
       }
      
      #panel {
        padding: 16px;
        display:block;
        margin: 0 auto 0 auto;
        text-align: center;
        align-items: center;
      }
      
      #map {
        width:95vw;
       max-width:400px;
        height: 400px;
        display:block;
        margin-left: auto;
        margin-right: auto;
        position: relative;
        left: 50%;
        transform: translateX(-50%);
      }
      }
    }

    .stat-row { display:flex; justify-content:space-between; align-items: center; margin:8px 0; padding:4px; border-radius:6px; }
    .stat-row.agree { background: rgba(109,127,151,.15);border-radius:6px; }
    .stat-row.disagree { background: rgba(196,54,86,.08);border-radius:6px; }
    .stat-label { font-weight:600; font-size:12px; }
    .stat-value { font-size:12px; font-weight:700; }
    .percentage { font-size:10px; color: var(--muted); margin-left:4px; }
    .total-votes { text-align:center; font-size:12px; margin:10px 0; padding:8px; background:#f8f9fa; border-radius:6px; }
    .big-bar { height:12px; background:#eee; border-radius:6px; margin:10px 0; overflow:hidden; position:relative; }
    .big-bar .agree-fill { background: var(--agree); }
    .big-bar .disagree-fill { background: var(--disagree); }
    .big-bar .total{background: }
    .region-info { margin-top:16px; padding-top:10px; border-top:1px solid #eee; }
    .region-title { font-size:16px; font-weight:700; margin-bottom:8px; }
  </style>
</head>
<body>
<div class="container">
  
  
  <p style="color:#666; font-size:20px;">點擊縣市顯示資料</p> 
  <div class="legend">
  <div class="legend-item">
    <div class="legend-color" style="background: var(--agree);"></div>
    <span>同意票居多</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background: var(--disagree);"></div>
    <span>不同意票居多</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background: #ccc;"></div>
    <span>尚無資料</span>
  </div>
</div>
  
  <div class="map-container">
    <div class="map-wrapper">
      <svg id="map"></svg>
      <div id="panel">
        <h2 style="font-size: 14px; margin-bottom: 8px;">全台票數統計</h2>
        <div id="totalStats"></div>
      </div>
    </div>
  </div>
  
  

</div>

<script>
const width = 700, height = 600;
const svg = d3.select("#map")
  .attr("width", "100%")
  .attr("height", height)
  .attr("viewBox", `0 0 ${width} ${height}`)
  .attr("preserveAspectRatio", "xMidYMid meet");

const projection = d3.geoMercator()
  .center([121, 24])
  .scale(6000)
  .translate([width / 2, height / 2]);

const path = d3.geoPath().projection(projection);

const voteData = {
   "基隆市": { agree: 70703, disagree: 17895},
   "台北市": { agree: 474894, disagree: 150014 },
   "新北市": { agree: 664376, disagree: 222465 },
   "桃園市": { agree: 429306, disagree: 98886},
   "台中市": { agree: 442847, disagree: 131245 },
   "台南市": { agree: 280927, disagree: 141370},
   "高雄市": { agree: 423651, disagree: 229579 },
   "新竹縣": { agree: 91566, disagree: 18931},
   "新竹市": { agree: 88880, disagree: 20982 },
   "苗栗縣": { agree: 113184, disagree: 17569},
   "彰化縣": { agree: 220325, disagree: 55651},
   "南投縣": { agree: 64472, disagree: 25502},
   "雲林縣": { agree: 98165, disagree: 29429 },
   "嘉義市": { agree: 43674, disagree: 17279},
   "嘉義縣": { agree: 71315, disagree: 27545 }, 
   "屏東縣": { agree: 120720, disagree: 90460 },
   "宜蘭縣": { agree: 62075, disagree: 26003 },
   "花蓮縣": { agree: 63040, disagree: 9956},
   "台東縣": { agree: 37858, disagree: 7191 },
   "澎湖縣": { agree: 13180, disagree: 4012},
   "金門縣": { agree: 14524, disagree: 893},
   "連江縣": { agree: 2129, disagree: 136 }
};
  
  const populationData = {
  "台北市": 2087808,
  "新北市": 3501235,
  "桃園市": 1971813,
  "台中市": 2416540,
  "台南市": 1600962,
  "高雄市": 2358186,
  "基隆市": 318691,
  "新竹市": 370898,
  "嘉義市": 221496,
  "新竹縣": 488509,
  "苗栗縣": 457783,
  "彰化縣": 1042775,
  "南投縣": 410405,
  "雲林縣": 567994,
  "嘉義縣": 424950,
  "屏東縣": 688202,
  "宜蘭縣": 388906,
  "花蓮縣": 271519,
  "台東縣": 181146,
  "澎湖縣": 94412,
  "金門縣": 125917,
  "連江縣": 11944
};

const tooltip = d3.select("body").append("div")
  .attr("class", "tooltip")
  .style("opacity", 0);

d3.json("https://raw.githubusercontent.com/g0v/twgeojson/master/json/twCounty2010.geo.json").then(function(taiwan) {
  
// 繪製主要的縣市地圖路徑
  svg.selectAll(".region")
    .data(taiwan.features)
    .enter().append("path")
    .attr("d", path)
    .attr("class", "region")
    .attr("fill", d => {
      let city = d.properties.COUNTYNAME;
      if(city === "桃園縣") city = "桃園市";  
      const data = voteData[city];
      if (!data) return "#ccc";
    
    if (data.agree === 0 && data.disagree === 0) {
    return "#ccc"; // 沒有資料 → 灰色
  }
      return data.agree > data.disagree ? "var(--agree)" : "var(--disagree)";
    })
  
  // ===== 為金門和連江縣創建隱形熱區 (Hitbox) =====
  const smallIslands = ["金門縣", "連江縣"];
  const hitboxRadius = 40; // 熱區圓形的半徑，您可以根據需要調整大小

  const islandFeatures = taiwan.features.filter(d => smallIslands.includes(d.properties.COUNTYNAME));

  svg.selectAll(".hitbox")
    .data(islandFeatures)
    .enter().append("circle")
    .attr("class", "hitbox")
    .attr("cx", d => path.centroid(d)[0]) // 計算縣市中心點的 x 坐標
    .attr("cy", d => path.centroid(d)[1]) // 計算縣市中心點的 y 坐標
    .attr("r", hitboxRadius)
    .style("fill", "transparent") // 完全透明，使用者看不到
    .style("cursor", "pointer");
    
  // ===== 將滑鼠事件綁定到所有 .region (可見地圖) 和 .hitbox (透明熱區) 上 =====
  svg.selectAll(".region, .hitbox")
  
    .on("mouseover", function(event, d) {
      let city = d.properties.COUNTYNAME;
      if(city === "桃園縣") city = "桃園市";
      const data = voteData[city];
      const population = populationData[city];
      if (!data || !population) return;

      const total = data.agree + data.disagree;
      const agreePct = (data.agree / total * 100).toFixed(2);
      const disagreePct = (data.disagree / total * 100).toFixed(2);
      const turnoutPct = (total / population * 100).toFixed(2);
      
      tooltip.transition().style("opacity", 1);
      tooltip.html(`
        <div class="inner">
          <h3>${city}</h3>
          
          <div class="row"><span class="pill agree">同意</span><span>${data.agree.toLocaleString()} (${agreePct}%)</span></div>
          <div class="bar" style="height:12px; background:rgba(109,127,151,.15); border-radius:6px; overflow:hidden; margin-bottom:6px;">
            <div class="fill" style="width:${agreePct}%; height:100%; background: var(--agree);"></div>
          </div>

          <div class="row"><span class="pill disagree">不同意</span><span>${data.disagree.toLocaleString()} (${disagreePct}%)</span></div>
          <div class="bar" style="height:12px; background:rgba(196,54,86,.08); border-radius:6px; overflow:hidden;">
            <div class="fill" style="width:${disagreePct}%; height:100%; background: var(--disagree);"></div>
          </div>

         <!--

        <div class="row"  style="margin-top:8px; padding-top:8px; border-top:1px solid #eee;"><span class="pill total">總投票數</span><span>${total.toLocaleString()} (${turnoutPct}%)</span></div>
         
        <div class="bar" style="height:12px; background:rgba(219,212,198,0.30); border-radius:6px; overflow:hidden; margin-bottom:6px;">
        <div class="fill" style="width:${turnoutPct}%; height:100%; background: #DBD4C6"></div>
        </div>

        <div class="row">
        <span style="font-size:11px; color:#666;">投票權人</span>
        <span style="font-size:11px; color:#666;">${population.toLocaleString()}</span>
        </div>
        -->

        </div>`)
      .style("left", (event.pageX - 100) + "px")
      .style("top", (event.pageY - 180) + "px");
    
    // 手動觸發對應可見地圖區域的高亮效果
      svg.selectAll('.region')
        .filter(p => p.properties.COUNTYNAME === city)
        .style('filter', 'brightness(1.3)')
        .style('stroke', '#F7931D')
        .style('stroke-width', '2px');   
    })
    
    .on("mousemove", function(event) {
      const tooltipNode = tooltip.node();
      const tooltipWidth = tooltipNode.offsetWidth || 220; // 預設寬度
      const tooltipHeight = tooltipNode.offsetHeight || 120;
      const margin = 10; // 與螢幕邊界保留距離

      let left = event.pageX - tooltipWidth / 2; 
      let top = event.pageY - tooltipHeight - 20; // 在滑鼠上方

     // 限制不要超出左右邊界
     if (left < margin) left = margin;
     if (left + tooltipWidth > window.innerWidth - margin) {
     left = window.innerWidth - tooltipWidth - margin;
     }

  // 限制不要超出上方（例如澎湖、金門）
  if (top < margin) top = event.pageY + 20; // 如果太上面，就改放在滑鼠下方

  tooltip.style("left", `${left}px`)
         .style("top", `${top}px`);
    })
    .on("mouseout", function() {
      tooltip.transition().duration(500).style("opacity", 0);
   
  // 滑鼠移出時，取消所有高亮效果
      svg.selectAll('.region')
        .style('filter', null)
        .style('stroke', null)
        .style('stroke-width', null)
        .style('fill-opacity',null);
  
  
  })
  // ===== 點擊地圖區域 =====
 
  .on("click", function(event, d) {
    let city = d.properties.COUNTYNAME;
    if(city === "桃園縣") city = "桃園市";
    const data = voteData[city];
    const population = populationData[city];
    if (!data || !population) return;

    const total = data.agree + data.disagree;
    const agreePct = (data.agree / total * 100).toFixed(2);
    const disagreePct = (data.disagree / total * 100).toFixed(2);
    const turnoutPct = (total / population * 100).toFixed(2);

    const panel = d3.select("#panel");
    panel.html(`
      <h3>全台票數統計</h3>
      <div id="totalStats"></div>
      <div class="region-info">
        <h3>${city}</h3>

        <!-- 同意票 -->
        <div class="bar agree" style="height:40px; border-radius:12px; background: rgba(109,127,151,.15); position: relative; margin:8px 0;overflow:hidden;">
          <div class="fill" style="width:${agreePct}%; height:100%; background: var(--agree); border-radius:12px 0 0 12px;opacity: 0.6"></div>
          <div style="position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:space-between; align-items:center; padding:0 12px; color: black; font-weight:bold;">
            <span>同意票</span>
            <span>${data.agree.toLocaleString()} (${agreePct}%)</span>
          </div>
        </div>

        <!-- 不同意票 -->
        <div class="bar disagree" style="height:40px; border-radius:12px; background: rgba(196,54,86,.08); position: relative; margin:8px 0;overflow:hidden;">
          <div class="fill" style="width:${disagreePct}%; height:100%; background: var(--disagree); border-radius:12px 0 0 12px;opacity: 0.6"></div>
          <div style="position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:space-between; align-items:center; padding:0 12px; color: black; font-weight:bold;">
            <span>不同意票</span>
            <span>${data.disagree.toLocaleString()} (${disagreePct}%)</span>
          </div>
        </div>

        <!-- 總投票數 
        <div class="bar total" style="height:40px; border-radius:12px; background:rgba(219,212,198,0.30); position: relative; margin:8px 0;overflow:hidden;">
          <div class="fill" style="width:${turnoutPct}%; height:100%; background: #DBD4C6; border-radius:12px 0 0 12px;opacity: 0.8"></div>
          <div style="position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:space-between; align-items:center; padding:0 12px; color: black; font-weight:bold;">
            <span>總投票數</span>
            <span>${total.toLocaleString()} (${turnoutPct}%)</span>
          </div>
        </div>
      </div>

      <div class="row" style=text-align:right>
        <span style="font-size:11px; color:#666">投票權人</span>
        <span style="font-size:11px; color:#666;">${population.toLocaleString()}</span>
      </div>
    `);
  -->

    displayTotalStats();

    // 停止事件冒泡，避免觸發 body click
    event.stopPropagation();
  });

// ===== 點擊地圖以外的地方 =====
d3.select("body").on("click", function() {
  const panel = d3.select("#panel");
  panel.html(`
    <h2 style="font-size: 14px; margin-bottom: 8px;">全台票數統計</h2>
    <div id="totalStats"></div>
  `);
  displayTotalStats();
});

// ===== 點擊 panel 本身不觸發 body click =====
d3.select("#panel").on("click", function(event) {
  event.stopPropagation();
});

  // 核三廠位置
  const npp3 = projection([120.751667, 21.958056]);

  // 加 emoji
  svg.append("text")
     .attr("x", npp3[0])
     .attr("y", npp3[1] + 5)
     .attr("text-anchor", "middle")
     .attr("font-size", "30px")
     .text("☢️");
    
  // 添加文字標籤
  svg.append("text")
      .attr("x", npp3[0] - 85)
      .attr("y", npp3[1] + 3)
      .attr("class", "marker-label")
      .style("font-size", "20px")
      .style("font-family", "微軟正黑體, sans-serif")
      .style("font-weight", "bold") 
      .style("fill", "#F7931D")
      .text("核三廠");
});

// ===== 全台統計函數 =====
function calculateTotalStats() {
  let totalAgree = 0;
  let totalDisagree = 0;

  Object.values(voteData).forEach(data => {
    totalAgree += data.agree;
    totalDisagree += data.disagree;
  });

  const total = totalAgree + totalDisagree;
  const totalPopulation = 20002091;
  const agreePct = (totalAgree / total * 100).toFixed(2);
  const disagreePct = (totalDisagree / total * 100).toFixed(2);

  return { totalAgree, totalDisagree, total, agreePct, disagreePct };
}

function displayTotalStats() {
  const stats = calculateTotalStats();
  const totalPopulation = 20002091;
  const threshold = 5000523;
  const turnoutTotal=0;

  const votePct = (stats.total / totalPopulation * 100).toFixed(2);
  const agreePctOfTotal = (stats.totalAgree / totalPopulation * 100).toFixed(2);
  const disagreePctOfTotal = (stats.totalDisagree / totalPopulation * 100).toFixed(2);
  const turnoutPctofTotal= (turnoutTotal / totalPopulation *100).toFixed(2);
  const thresholdPct = (threshold / totalPopulation * 100).toFixed(2);


  d3.select("#totalStats").html(`
    
 <div style="position: relative; margin:16px 0; padding-top:20px;">
      <div class="big-bar" style="background:#eee; height:20px; border-radius:12px; position:relative;overflow: hidden">
        <div style="position:absolute; top:0; left:0; height:20px; width:${agreePctOfTotal}%; background: var(--agree); border-radius:12px 0 0 12px;opacity: 0.65"></div>
        <div class="threshold" style="position:absolute; left:${thresholdPct}%; top:0; width:3px; height:100%; background: #F7931D;"></div>
        
      </div>
      <div style="position:absolute; left:${thresholdPct}%; top:-5px; transform:translateX(-50%); font-size:12px; font-weight:bold; color:#F7931D; white-space:nowrap; text-align:center;">
        同意門檻<br>${threshold.toLocaleString()}人
      </div>
      <div style="position:absolute; left:99%; bottom:0; width:3px; height:20px; background:#F7931D;"></div>
      <div style="position:absolute; left:88%; top:-5px; transform:translateX(-50%); font-size:12px; font-weight:bold; color:#F7931D; white-space:nowrap; text-align:center;">
        總投票權人<br>20,002,091人
      </div>
    </div>

    <!-- 同意票 -->
          <div class="bar agree" style="height:40px; border-radius:12px; background: rgba(109,127,151,.15); position: relative; margin:8px 0;overflow:hidden;">
            <div class="fill" style="width:${stats.agreePct}%; height:100%; background: var(--agree); border-radius:12px 0 0 12px;opacity: 0.6;"></div>
            <div style="position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:space-between; align-items:center; padding:0 12px; color: black; font-weight:bold;">
              <span>同意票</span>
              <span>${stats.totalAgree.toLocaleString()} (${stats.agreePct}%)</span>
            </div>
          </div>

          <!-- 不同意票 -->
          <div class="bar disagree" style="height:40px; border-radius:12px; background: rgba(196,54,86,.08); position: relative; margin:8px 0;overflow:hidden;">
            <div class="fill" style="width:${stats.disagreePct}%; height:100%; background: var(--disagree); border-radius:12px 0 0 12px;opacity: 0.6;"></div>
            <div style="position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:space-between; align-items:center; padding:0 12px; color: black; font-weight:bold;">
              <span>不同意票</span>
              <span>${stats.totalDisagree.toLocaleString()} (${stats.disagreePct}%)</span>
            </div>
          </div>
      

  

     <!-- 總投票數  
          <div class="bar total" style="height:40px; border-radius:12px; background:rgba(219,212,198,0.30); position: relative; margin:8px 0;overflow:hidden;">
            <div class="fill" style="width:${turnoutPctofTotal}%; height:100%; background: #DBD4C6; border-radius:12px 0 0 12px;opacity: 0.8"></div>
            <div style="position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:space-between; align-items:center; padding:0 12px; color: black; font-weight:bold;">
              <span>總投票數</span>
              <span>${turnoutTotal.toLocaleString()} (${turnoutPctofTotal}%)</span>
            </div>
          </div>
-->

  `);
}

displayTotalStats();
</script>
  <script>
    
    
document.addEventListener("DOMContentLoaded", () => {
  const tooltips = document.querySelectorAll(".tooltip");

  function hideTooltips() {
    tooltips.forEach(t => {
      t.style.opacity = "0";
    });
  }

  // 只在手機/平板啟用
  if (/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    document.addEventListener("touchmove", hideTooltips, { passive: true });
    document.addEventListener("touchstart", hideTooltips, { passive: true });
    document.addEventListener("scroll", hideTooltips, { passive: true });
  }
});
</script>

</body>
</html>




